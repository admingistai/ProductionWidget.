<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Widget Test</title>
  <link rel="icon" type="image/svg+xml" href="./public/svg-2.svg">
  <link rel="alternate icon" href="./public/favicon.ico">
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      padding: 40px;
      max-width: 800px;
      margin: 0 auto;
    }
    .status {
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      background: #f0f0f0;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>Gist Widget Local Test</h1>
  
  <div id="status" class="status">
    <h3>Widget Status</h3>
    <p id="status-text">Loading widget...</p>
  </div>

  <h2>Test Instructions</h2>
  <ol>
    <li><strong>Get OpenAI API Key:</strong> Visit <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a> and create an API key</li>
    <li><strong>Enter API Key:</strong> Paste your API key in the input field below</li>
    <li><strong>Test Connection:</strong> Click "Test API Connection" to verify your key works</li>
    <li><strong>Initialize Widget:</strong> Click "Initialize with OpenAI" to activate the chat widget</li>
    <li><strong>Test Chat:</strong> The widget appears at the bottom center - click to expand and try asking questions</li>
    <li><strong>Check Console:</strong> Open browser console (F12) to see debug logs and any errors</li>
  </ol>
  
  <div class="status">
    <h4>üí° Expected Console Output:</h4>
    <pre>üîß Widget initialization starting... {hasApiKey: true, ...}
ü§ñ Creating OpenAI client...
‚úÖ OpenAI client created successfully
üîç API call attempted {hasClient: true, ...}</pre>
  </div>

  <h2>OpenAI Configuration</h2>
  <p><strong>Note:</strong> This widget now uses OpenAI directly. You need an API key to test chat functionality.</p>
  
  <div class="api-config">
    <label for="apiKeyInput">OpenAI API Key:</label><br>
    <input type="password" id="apiKeyInput" placeholder="sk-your-openai-api-key-here" style="width: 300px; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px;">
    <br>
    <small>Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a></small>
  </div>

  <h2>Manual Control</h2>
  <button onclick="destroyWidget()">Destroy Widget</button>
  <button onclick="initWidget()">Initialize with OpenAI</button>
  <button onclick="testConnection()">Test API Connection</button>

  <!-- Load widget from dist folder -->
  <script src="./dist/widget.iife.js"></script>
  <script>
    // Update status display
    function updateStatus(type, message) {
      const statusEl = document.getElementById('status');
      const statusText = document.getElementById('status-text');
      statusEl.className = `status ${type}`;
      statusText.textContent = message;
    }

    // Check if widget loaded
    setTimeout(() => {
      if (window.GistWidget) {
        updateStatus('success', '‚úÖ Widget loaded successfully! Enter your OpenAI API key below to test.');
        console.log('GistWidget API available:', window.GistWidget);
      } else {
        updateStatus('error', '‚ùå Widget failed to load. Check console for errors.');
      }
    }, 1000);

    function destroyWidget() {
      if (window.GistWidget) {
        window.GistWidget.destroy();
        console.log('Widget destroyed');
      }
    }

    function initWidget() {
      const apiKey = document.getElementById('apiKeyInput')?.value.trim();
      
      if (!apiKey) {
        alert('Please enter your OpenAI API key first');
        return;
      }
      
      if (window.GistWidget) {
        window.GistWidget.destroy(); // Clean destroy first
        
        setTimeout(() => {
          window.GistWidget.init({
            apiKey: apiKey, // OpenAI API key
            model: 'gpt-3.5-turbo', // OpenAI model
            maxTokens: 500, // Max response tokens
            temperature: 0.7, // Creativity setting
            theme: 'light',
            placeholder: 'Ask me anything about this site...',
            enableWebsiteContext: true,
            customSystemPrompt: 'You are a helpful AI assistant for this website.'
          });
          console.log('Widget re-initialized with OpenAI config');
          updateStatus('success', '‚úÖ Widget initialized with OpenAI! Try asking a question.');
        }, 500);
      }
    }

    // Test OpenAI API connection
    async function testConnection() {
      const apiKey = document.getElementById('apiKeyInput')?.value.trim();
      
      if (!apiKey) {
        updateStatus('error', '‚ùå Please enter your OpenAI API key first');
        return;
      }

      if (!apiKey.startsWith('sk-')) {
        updateStatus('error', '‚ùå API key should start with "sk-"');
        return;
      }

      try {
        updateStatus('', 'üîÑ Testing OpenAI API connection...');
        
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [
              { role: 'user', content: 'Hello! Just testing the connection.' }
            ],
            max_tokens: 50
          })
        });

        if (response.ok) {
          const data = await response.json();
          updateStatus('success', '‚úÖ OpenAI API connection successful! You can now initialize the widget.');
          console.log('API test response:', data);
        } else {
          const error = await response.json();
          updateStatus('error', `‚ùå API Error: ${error.error?.message || 'Unknown error'}`);
          console.error('API test error:', error);
        }
      } catch (error) {
        updateStatus('error', `‚ùå Connection failed: ${error.message}`);
        console.error('Connection test failed:', error);
      }
    }
  </script>
</body>
</html>