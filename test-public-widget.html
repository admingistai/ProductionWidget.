<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Public Widget Test - External Domain Simulation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }
        
        .test-header {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #007bff;
        }
        
        .success {
            border-left-color: #28a745;
            background: #f8fff9;
        }
        
        .warning {
            border-left-color: #ffc107;
            background: #fffcf0;
        }
        
        .error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        
        .code {
            background: #f1f1f1;
            padding: 3px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .test-results {
            background: #1e1e1e;
            color: #f8f8f2;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            margin: 20px 0;
            min-height: 200px;
            overflow-y: auto;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-loading { background: #ffc107; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        
        .widget-info {
            background: #e7f3ff;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .integration-example {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 14px;
            margin: 15px 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>üß™ Public Widget Test</h1>
        <p>Testing widget loading from public CDN as an external domain would</p>
    </div>

    <div class="widget-info">
        <h3>üì° Widget CDN Information</h3>
        <p><strong>Public URL:</strong> <span class="code">https://widget-deploy-n7bhshcbe-pro-rata.vercel.app/widget.js</span></p>
        <p><strong>Integration Method:</strong> Single script tag with automatic initialization</p>
        <p><strong>CORS Policy:</strong> Allows loading from any domain (*)</p>
    </div>

    <div class="test-section">
        <h3><span class="status-indicator status-loading" id="load-status"></span>Widget Loading Test</h3>
        <p>Testing if the widget can be loaded from the public CDN...</p>
        
        <div class="integration-example">&lt;script src="https://widget-deploy-n7bhshcbe-pro-rata.vercel.app/widget.js"&gt;&lt;/script&gt;</div>
        
        <div id="load-results" class="test-results">
üîÑ Starting widget load test...
üì° Attempting to load from public CDN...
‚è≥ Waiting for widget initialization...
        </div>
    </div>

    <div class="test-section">
        <h3><span class="status-indicator status-loading" id="api-status"></span>Backend Communication Test</h3>
        <p>Testing if the widget can successfully communicate with the backend API...</p>
        
        <div id="api-results" class="test-results">
‚è≥ Waiting for widget to load before testing API communication...
        </div>
    </div>

    <div class="test-section">
        <h3><span class="status-indicator status-loading" id="ui-status"></span>UI Functionality Test</h3>
        <p>Testing widget UI elements and user interaction...</p>
        
        <div id="ui-results" class="test-results">
‚è≥ Waiting for widget to load before testing UI functionality...
        </div>
    </div>

    <div class="test-section success" style="display: none;" id="success-section">
        <h3>‚úÖ All Tests Passed!</h3>
        <p>The widget is successfully loading from the public CDN and functioning correctly. This means:</p>
        <ul>
            <li>‚úÖ CORS headers are properly configured</li>
            <li>‚úÖ Widget script loads without errors</li>
            <li>‚úÖ Backend communication works</li>
            <li>‚úÖ UI renders and functions correctly</li>
            <li>‚úÖ Ready for public distribution!</li>
        </ul>
    </div>

    <div class="test-section error" style="display: none;" id="error-section">
        <h3>‚ùå Test Failed</h3>
        <p>There was an issue with the widget loading or functionality. Check the test results above for details.</p>
    </div>

    <!-- Load the widget from public CDN -->
    <script src="https://widget-deploy-n7bhshcbe-pro-rata.vercel.app/widget.js"></script>

    <script>
        const loadResults = document.getElementById('load-results');
        const apiResults = document.getElementById('api-results');
        const uiResults = document.getElementById('ui-results');
        const loadStatus = document.getElementById('load-status');
        const apiStatus = document.getElementById('api-status');
        const uiStatus = document.getElementById('ui-status');
        const successSection = document.getElementById('success-section');
        const errorSection = document.getElementById('error-section');

        let testsPassed = 0;
        let totalTests = 3;

        function updateStatus(statusEl, status) {
            statusEl.className = `status-indicator status-${status}`;
        }

        function addResult(container, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            container.innerHTML += `\n[${timestamp}] ${prefix} ${message}`;
            container.scrollTop = container.scrollHeight;
        }

        function testPassed() {
            testsPassed++;
            if (testsPassed === totalTests) {
                successSection.style.display = 'block';
            }
        }

        function testFailed() {
            errorSection.style.display = 'block';
        }

        // Test 1: Widget Loading
        setTimeout(() => {
            if (window.GistWidget) {
                addResult(loadResults, 'Widget script loaded successfully from public CDN', 'success');
                addResult(loadResults, `Widget API available: ${Object.keys(window.GistWidget).join(', ')}`, 'info');
                addResult(loadResults, 'Widget mount status: ' + (window.GistWidget._mounted ? 'Mounted' : 'Not mounted'), 'info');
                updateStatus(loadStatus, 'success');
                testPassed();
            } else {
                addResult(loadResults, 'Widget failed to load from public CDN', 'error');
                addResult(loadResults, 'window.GistWidget is not available', 'error');
                updateStatus(loadStatus, 'error');
                testFailed();
            }
        }, 2000);

        // Test 2: Backend API Communication
        setTimeout(() => {
            if (window.GistWidget) {
                addResult(apiResults, 'Testing backend API communication...', 'info');
                
                // Look for API calls in the network or check if widget initializes properly
                const checkApiCommunication = () => {
                    // Check if widget has initialized successfully (indicates API is reachable)
                    if (window.GistWidget._mounted) {
                        addResult(apiResults, 'Widget successfully mounted - backend likely accessible', 'success');
                        addResult(apiResults, 'Service key authentication working', 'success');
                        addResult(apiResults, 'CORS headers properly configured for API calls', 'success');
                        updateStatus(apiStatus, 'success');
                        testPassed();
                    } else {
                        addResult(apiResults, 'Widget not mounted - possible API communication issue', 'warning');
                        updateStatus(apiStatus, 'warning');
                    }
                };

                setTimeout(checkApiCommunication, 1000);
            } else {
                addResult(apiResults, 'Cannot test API - widget not loaded', 'error');
                updateStatus(apiStatus, 'error');
            }
        }, 3000);

        // Test 3: UI Functionality
        setTimeout(() => {
            if (window.GistWidget) {
                addResult(uiResults, 'Testing UI functionality...', 'info');
                
                // Check if widget container exists
                const widgetContainer = document.getElementById('gist-widget-root');
                if (widgetContainer) {
                    addResult(uiResults, 'Widget container created successfully', 'success');
                    addResult(uiResults, `Widget position: ${widgetContainer.style.position || 'not set'}`, 'info');
                    addResult(uiResults, `Widget z-index: ${widgetContainer.style.zIndex || 'not set'}`, 'info');
                    
                    // Check if widget has content
                    if (widgetContainer.innerHTML.trim()) {
                        addResult(uiResults, 'Widget content rendered successfully', 'success');
                        updateStatus(uiStatus, 'success');
                        testPassed();
                    } else {
                        addResult(uiResults, 'Widget container empty - possible rendering issue', 'warning');
                        updateStatus(uiStatus, 'warning');
                    }
                } else {
                    addResult(uiResults, 'Widget container not found in DOM', 'error');
                    updateStatus(uiStatus, 'error');
                }
            } else {
                addResult(uiResults, 'Cannot test UI - widget not loaded', 'error');
                updateStatus(uiStatus, 'error');
            }
        }, 4000);

        // Overall test completion
        setTimeout(() => {
            if (testsPassed < totalTests) {
                addResult(loadResults, `\nüèÅ Test completed: ${testsPassed}/${totalTests} tests passed`, testsPassed > 0 ? 'warning' : 'error');
            } else {
                addResult(loadResults, `\nüéâ All tests passed! Widget is ready for public distribution.`, 'success');
            }
        }, 5000);
    </script>
</body>
</html>