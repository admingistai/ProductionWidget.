<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Backend API Test - Gist AI Widget</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1, h2 {
      color: #333;
    }
    .test-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    .test-button:hover {
      background: #0056b3;
    }
    .test-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .config-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>ðŸ¤– Gist AI Widget - Backend API Test</h1>
  
  <div class="test-section">
    <h2>Configuration</h2>
    <div class="config-section">
      <label>
        API Endpoint:
        <input type="text" id="apiEndpoint" value="http://localhost:3000/api/chat" />
      </label>
      <label>
        Service Key:
        <input type="text" id="serviceKey" placeholder="Enter your service key" />
      </label>
    </div>
  </div>

  <div class="test-section">
    <h2>1. Health Check</h2>
    <p>Test if the API is running and properly configured.</p>
    <button class="test-button" onclick="testHealth()">Test Health Endpoint</button>
    <div id="healthResult"></div>
  </div>

  <div class="test-section">
    <h2>2. Authentication Test</h2>
    <p>Test if the service key authentication works.</p>
    <button class="test-button" onclick="testAuth()">Test Authentication</button>
    <div id="authResult"></div>
  </div>

  <div class="test-section">
    <h2>3. Chat API Test</h2>
    <p>Test the main chat endpoint with a sample question.</p>
    <input type="text" id="testQuestion" placeholder="Enter a test question" value="What is this website about?" />
    <button class="test-button" onclick="testChat()">Test Chat API</button>
    <div id="chatResult"></div>
  </div>

  <div class="test-section">
    <h2>4. Rate Limit Test</h2>
    <p>Test rate limiting by sending multiple requests.</p>
    <button class="test-button" onclick="testRateLimit()">Test Rate Limit</button>
    <div id="rateLimitResult"></div>
  </div>

  <script>
    // Mock website context for testing
    const mockWebsiteContext = {
      summary: "This is a test website for the Gist AI Widget",
      businessProfile: "AI Widget Development Company",
      pageContext: "Testing page for backend API integration",
      keyFeatures: ["AI Chat", "Website Context", "Secure API"],
      estimatedTokens: 100
    };

    function getConfig() {
      return {
        endpoint: document.getElementById('apiEndpoint').value,
        serviceKey: document.getElementById('serviceKey').value
      };
    }

    function showResult(elementId, success, data) {
      const element = document.getElementById(elementId);
      element.className = success ? 'result success' : 'result error';
      element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    }

    async function testHealth() {
      const { endpoint } = getConfig();
      const healthEndpoint = endpoint.replace('/chat', '/health');
      
      try {
        const response = await fetch(healthEndpoint);
        const data = await response.json();
        showResult('healthResult', response.ok, data);
      } catch (error) {
        showResult('healthResult', false, `Error: ${error.message}`);
      }
    }

    async function testAuth() {
      const { endpoint, serviceKey } = getConfig();
      
      try {
        // Test without auth
        const response1 = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            question: 'test',
            websiteContext: mockWebsiteContext
          })
        });
        
        // Test with auth
        const response2 = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${serviceKey}`
          },
          body: JSON.stringify({
            question: 'test',
            websiteContext: mockWebsiteContext
          })
        });
        
        const result = {
          withoutAuth: { status: response1.status, body: await response1.json() },
          withAuth: { status: response2.status, body: await response2.json() }
        };
        
        showResult('authResult', response2.ok, result);
      } catch (error) {
        showResult('authResult', false, `Error: ${error.message}`);
      }
    }

    async function testChat() {
      const { endpoint, serviceKey } = getConfig();
      const question = document.getElementById('testQuestion').value;
      
      try {
        const startTime = Date.now();
        
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${serviceKey}`,
            'X-Session-ID': 'test-session-123',
            'X-Client-Version': '1.0.0'
          },
          body: JSON.stringify({
            question,
            websiteContext: mockWebsiteContext,
            conversation: []
          })
        });
        
        const data = await response.json();
        const duration = Date.now() - startTime;
        
        const result = {
          ...data,
          _meta: {
            duration: `${duration}ms`,
            status: response.status
          }
        };
        
        showResult('chatResult', response.ok, result);
      } catch (error) {
        showResult('chatResult', false, `Error: ${error.message}`);
      }
    }

    async function testRateLimit() {
      const { endpoint, serviceKey } = getConfig();
      const results = [];
      
      try {
        // Send 5 requests rapidly
        for (let i = 0; i < 5; i++) {
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${serviceKey}`
            },
            body: JSON.stringify({
              question: `Rate limit test ${i + 1}`,
              websiteContext: mockWebsiteContext,
              conversation: []
            })
          });
          
          results.push({
            request: i + 1,
            status: response.status,
            statusText: response.statusText,
            retryAfter: response.headers.get('Retry-After')
          });
          
          // Stop if we hit rate limit
          if (response.status === 429) break;
        }
        
        showResult('rateLimitResult', true, results);
      } catch (error) {
        showResult('rateLimitResult', false, `Error: ${error.message}`);
      }
    }

    // Load service key from localStorage if available
    window.onload = function() {
      const savedKey = localStorage.getItem('gist-widget-service-key');
      if (savedKey) {
        document.getElementById('serviceKey').value = savedKey;
      }
    };

    // Save service key to localStorage on change
    document.getElementById('serviceKey').addEventListener('change', function(e) {
      localStorage.setItem('gist-widget-service-key', e.target.value);
    });
  </script>
</body>
</html>