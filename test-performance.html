<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Widget Animation Performance Test</title>
  <link rel="icon" type="image/svg+xml" href="./public/svg-2.svg">
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      padding: 40px;
      max-width: 1200px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      margin: 5px;
      padding: 8px 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover {
      background: #f0f0f0;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .metrics {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .metric {
      display: inline-block;
      margin: 10px 20px 10px 0;
    }
    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #2563eb;
    }
    .metric-label {
      font-size: 14px;
      color: #666;
    }
    #fps-display {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: #00ff00;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      z-index: 10000;
    }
    .performance-good { color: #00ff00; }
    .performance-ok { color: #ffff00; }
    .performance-bad { color: #ff0000; }
  </style>
</head>
<body>
  <h1>Widget Animation Performance Test</h1>
  
  <div id="fps-display">FPS: <span id="fps-value">0</span></div>
  
  <div class="controls">
    <h2>Animation Controls</h2>
    <button onclick="toggleWidget()">Toggle Widget (Auto)</button>
    <button onclick="rapidToggle()">Rapid Toggle (10x)</button>
    <button onclick="stressTest()">Stress Test (50x)</button>
    <button onclick="resetWidget()">Reset Widget</button>
    <button onclick="toggleTheme()">Toggle Theme</button>
  </div>
  
  <div class="metrics">
    <h2>Performance Metrics</h2>
    <div class="metric">
      <div class="metric-value" id="avg-fps">0</div>
      <div class="metric-label">Average FPS</div>
    </div>
    <div class="metric">
      <div class="metric-value" id="min-fps">0</div>
      <div class="metric-label">Min FPS</div>
    </div>
    <div class="metric">
      <div class="metric-value" id="animation-time">0ms</div>
      <div class="metric-label">Animation Time</div>
    </div>
    <div class="metric">
      <div class="metric-value" id="render-count">0</div>
      <div class="metric-label">Render Count</div>
    </div>
  </div>
  
  <div class="controls">
    <h2>Animation Analysis</h2>
    <p id="analysis">Click the controls above to test animation performance.</p>
  </div>

  <!-- Load widget -->
  <script src="./dist/widget.iife.js"></script>
  
  <script>
    // FPS Counter
    let lastTime = performance.now();
    let frames = 0;
    let fps = 0;
    let fpsHistory = [];
    let renderCount = 0;
    let animationStartTime = 0;
    let isAnimating = false;
    
    function updateFPS() {
      frames++;
      const currentTime = performance.now();
      if (currentTime >= lastTime + 1000) {
        fps = Math.round((frames * 1000) / (currentTime - lastTime));
        frames = 0;
        lastTime = currentTime;
        
        const fpsElement = document.getElementById('fps-value');
        fpsElement.textContent = fps;
        fpsElement.className = fps >= 55 ? 'performance-good' : fps >= 30 ? 'performance-ok' : 'performance-bad';
        
        if (isAnimating) {
          fpsHistory.push(fps);
          updateMetrics();
        }
      }
      requestAnimationFrame(updateFPS);
    }
    requestAnimationFrame(updateFPS);
    
    function updateMetrics() {
      if (fpsHistory.length > 0) {
        const avgFps = Math.round(fpsHistory.reduce((a, b) => a + b) / fpsHistory.length);
        const minFps = Math.min(...fpsHistory);
        document.getElementById('avg-fps').textContent = avgFps;
        document.getElementById('min-fps').textContent = minFps;
        
        // Update analysis
        let analysis = '';
        if (avgFps >= 58) {
          analysis = '✅ Excellent! Achieving near-perfect 60fps animation.';
        } else if (avgFps >= 50) {
          analysis = '👍 Good performance. Smooth animation with minor frame drops.';
        } else if (avgFps >= 30) {
          analysis = '⚠️ Acceptable performance. Some stuttering may be visible.';
        } else {
          analysis = '❌ Poor performance. Animation is not smooth.';
        }
        document.getElementById('analysis').textContent = analysis;
      }
      document.getElementById('render-count').textContent = renderCount;
    }
    
    // Widget control functions
    function getWidgetButton() {
      const container = document.getElementById('gist-widget-root');
      if (!container) return null;
      return container.querySelector('button') || container.querySelector('[role="button"]');
    }
    
    function toggleWidget() {
      const button = getWidgetButton();
      if (button) {
        isAnimating = true;
        animationStartTime = performance.now();
        renderCount++;
        button.click();
        
        // Measure animation duration
        setTimeout(() => {
          const animationTime = performance.now() - animationStartTime;
          document.getElementById('animation-time').textContent = Math.round(animationTime) + 'ms';
          isAnimating = false;
        }, 500);
      }
    }
    
    async function rapidToggle() {
      fpsHistory = [];
      renderCount = 0;
      for (let i = 0; i < 10; i++) {
        toggleWidget();
        await new Promise(resolve => setTimeout(resolve, 600));
      }
    }
    
    async function stressTest() {
      fpsHistory = [];
      renderCount = 0;
      const startTime = performance.now();
      for (let i = 0; i < 50; i++) {
        toggleWidget();
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      const totalTime = performance.now() - startTime;
      document.getElementById('analysis').textContent += ` Stress test completed in ${Math.round(totalTime)}ms.`;
    }
    
    function resetWidget() {
      if (window.GistWidget) {
        window.GistWidget.destroy();
        window.GistWidget.init({ theme: 'light' });
        fpsHistory = [];
        renderCount = 0;
        updateMetrics();
      }
    }
    
    function toggleTheme() {
      if (window.GistWidget) {
        // Trigger theme toggle by clicking the theme button
        const themeButton = document.querySelector('[aria-label*="mode"]');
        if (themeButton) {
          themeButton.click();
        }
      }
    }
  </script>
</body>
</html>